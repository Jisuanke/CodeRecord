<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <script src="lib/codemirror.js"></script>
    <link rel="stylesheet" href="lib/codemirror.css"/>
    <title>代码录放</title>
</head>
<body>
<form action="">
    <textarea name="code" id="code" cols="30" rows="10"></textarea>
    <input type="button" onclick="replay()" value="回放" width="30"/>
    <textarea name="re" id="re" cols="30" rows="10"></textarea>
</form>
<script>
    var i = 0;
    var time, beginTime, outTime, word, beginWord, action, select;
    var record = [];

    //屏蔽剪切、复制、粘贴
    var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
        lineNumbers: true,
        extraKeys: {
            "Ctrl-A": function () {
                CodeMirror.commands.selectAll(editor);
                action = "selectAll";
                select = editor.getValue();
            }
        }
    });
    var reeditor = CodeMirror.fromTextArea(document.getElementById("re"), {
        lineNumbers: true
    });

    editor.on("cursorActivity", function () {
        var pos = editor.getCursor();
        var date = new Date();
        if ( i == 0 ) {
            beginTime = date.getTime();
            time = 0;
            word = editor.getValue();
            action = "insert";
        }
        else {
            word = editor.getValue();
            time = date.getTime() - beginTime;
            beginTime = date.getTime();
            if ( word.length < beginWord.length ) {
                word = "\\b";
                action = "backspace"
            }
            else if ( pos.line > record[i - 1].line ) {
                word = "\\n";
                action = "enter";
            }
            else {
                word = editor.getValue().replace(beginWord, "");
                action = "insert";
            }
        }
        if ( editor.getValue() == "" ) {
            action = "clean";
        }
        if ( word == "" ) {
            action = "move";
        }

        select = editor.getSelection();
        if ( select != "" ) {
            action = "selected";
        }

        record.push({"line": pos.line, "ch": pos.ch, "content": word, "onTime": time, "action": action, "select": select});
        console.log(record[i]);
        beginWord = editor.getValue();
        i++;
    });

    var j = 0;

    function replay() {
        if ( j == 0 ) {
            reeditor.setValue = record[j].content;
        }
        if ( j < i ) {

        }
    }
</script>
</body>
</html>